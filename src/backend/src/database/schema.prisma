// Yume Chatbot - Database Schema
// This is your Prisma schema file

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// User Management
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  avatar       String?
  role         Role     @default(USER)
  isActive     Boolean  @default(true) @map("is_active")
  lastSeen     DateTime @default(now()) @map("last_seen")
  preferences  Json?    // User preferences (theme, language, etc)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  conversations Conversation[]
  messages      Message[]
  sessions      Session[]
  apiKeys       ApiKey[]
  activities    UserActivity[]

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  token        String   @unique
  refreshToken String?  @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Conversation Management
model Conversation {
  id        String            @id @default(cuid())
  userId    String            @map("user_id")
  title     String?
  status    ConversationStatus @default(ACTIVE)
  context   Json?             // Conversation context and metadata
  settings  Json?             // AI settings for this conversation
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  userId         String   @map("user_id")
  role           MessageRole
  content        String
  tokens         Int?     // Token count for this message
  model          String?  // AI model used (if bot message)
  metadata       Json?    // Additional metadata (attachments, reactions, etc)
  isDeleted      Boolean  @default(false) @map("is_deleted")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// Knowledge Base
model KnowledgeBase {
  id          String    @id @default(cuid())
  title       String
  content     String
  category    String
  tags        String[]
  priority    Int       @default(5)
  intent      String?
  embedding   Unsupported("vector(1536)")? // Vector for semantic search
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("knowledge_base")
}

// Metrics and Analytics
model MetricsEvent {
  id        String   @id @default(cuid())
  name      String
  payload   Json
  userId    String?  @map("user_id")
  sessionId String?  @map("session_id")
  timestamp DateTime @default(now())

  @@index([name, timestamp])
  @@map("metrics_events")
}

model MetricsAggregation {
  id        String   @id @default(cuid())
  metric    String
  dimension String?
  value     Float
  count     Int      @default(1)
  date      DateTime
  hour      Int?
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([metric, dimension, date, hour])
  @@index([metric, date])
  @@map("metrics_aggregations")
}

// Admin and Monitoring
model AdminLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  action    String
  details   Json?
  ipAddress String?  @map("ip_address")
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@map("admin_logs")
}

model SystemHealth {
  id            String   @id @default(cuid())
  service       String
  status        HealthStatus
  responseTime  Int?     @map("response_time") // in milliseconds
  errorMessage  String?  @map("error_message")
  metadata      Json?
  timestamp     DateTime @default(now())

  @@index([service, timestamp])
  @@map("system_health")
}

// API Management
model ApiKey {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  key         String   @unique
  permissions String[] // Array of permissions
  lastUsed    DateTime? @map("last_used")
  isActive    Boolean  @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// User Activity Tracking
model UserActivity {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  action    String
  details   Json?
  timestamp DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@map("user_activities")
}

// File Management
model FileUpload {
  id          String     @id @default(cuid())
  userId      String     @map("user_id")
  filename    String
  originalName String    @map("original_name")
  mimeType    String     @map("mime_type")
  size        Int
  path        String
  status      FileStatus @default(PROCESSING)
  metadata    Json?
  createdAt   DateTime   @default(now()) @map("created_at")

  @@map("file_uploads")
}

// Rate Limiting
model RateLimit {
  id          String   @id @default(cuid())
  identifier  String   // IP address or user ID
  action      String   // Action type (e.g., 'chat', 'upload')
  count       Int      @default(1)
  windowStart DateTime @map("window_start")
  expiresAt   DateTime @map("expires_at")

  @@unique([identifier, action, windowStart])
  @@index([identifier, action])
  @@map("rate_limits")
}

// Enums
enum Role {
  USER
  PREMIUM
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  DOWN
}

enum FileStatus {
  PROCESSING
  COMPLETED
  FAILED
  DELETED
}