<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cici - Assistente Inteligente</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712027.png">

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script type="text/javascript">
        // CLARITY (Monitoramento)
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "SEU_ID_DO_CLARITY"); 
    </script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #6c5ce7; 
            --primary-dark: #4834d4;
            --bg-app: #dfe6e9;
            --bg-chat: #ffffff;
            --text-main: #2d3436;
            --cici-bubble: #a29bfe;
            --cici-text: #ffffff; /* Texto branco na bolha da Cici */
            --user-bubble: #fab1a0;
            --user-text: #2d3436;
            --font-size: 18px;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --menu-bg: rgba(255, 255, 255, 0.98);
        }

        body.alto-contraste {
            --primary: #000000;
            --primary-dark: #333;
            --bg-app: #000000;
            --bg-chat: #000000;
            --text-main: #ffff00;
            --cici-bubble: #333333;
            --cici-text: #ffffff;
            --user-bubble: #ffff00;
            --user-text: #000000;
            --menu-bg: #1a1a1a;
            --shadow: none;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: var(--font-size);
            overflow: hidden;
        }

        /* --- FORMATA√á√ÉO DE TEXTO (MARKDOWN) --- */
        /* Isso garante que listas e negritos fiquem bonitos */
        .mensagem p { margin: 5px 0; }
        .mensagem ul, .mensagem ol { margin: 5px 0 5px 20px; padding: 0; }
        .mensagem strong { font-weight: 800; }
        .mensagem a { color: inherit; text-decoration: underline; }

        /* --- CABE√áALHO --- */
        header {
            background-color: var(--primary);
            color: white;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow);
            z-index: 20;
            position: relative;
        }

        .menu-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; width: 40px; }
        .logo-area { font-size: 1.4em; font-weight: 800; position: absolute; left: 50%; transform: translateX(-50%); display:flex; gap:5px; align-items:center; }

        /* --- MENU LATERAL --- */
        #overlay-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 25;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #overlay-menu.aberto { opacity: 1; pointer-events: all; }

        #side-menu {
            position: fixed; top: 0; left: -280px; width: 260px; height: 100%;
            background: var(--menu-bg);
            z-index: 30;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        #side-menu.aberto { left: 0; }
        
        .menu-item {
            background: none; border: none; color: var(--text-main);
            padding: 15px; text-align: left; font-size: 1em; font-weight: 600;
            border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px;
            transition: 0.2s;
        }
        .menu-item:hover { background-color: rgba(0,0,0,0.05); }
        .menu-titulo { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: var(--primary); }
        .menu-divider { height: 1px; background: #ccc; margin: 10px 0; opacity: 0.5; }

        /* --- CHAT --- */
        #chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: var(--bg-chat);
            scroll-behavior: smooth;
        }

        .mensagem-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        .cici-wrapper { align-self: flex-start; }
        .usuario-wrapper { align-self: flex-end; align-items: flex-end; }

        .mensagem {
            padding: 15px 20px;
            border-radius: 20px;
            line-height: 1.5;
            box-shadow: var(--shadow);
            word-wrap: break-word;
        }

        .cici { background-color: var(--cici-bubble); color: var(--cici-text); border-bottom-left-radius: 5px; }
        .usuario { background-color: var(--user-bubble); color: var(--user-text); border-bottom-right-radius: 5px; }

        /* Bot√£o copiar abaixo da mensagem */
        .btn-copiar {
            background: none; border: none; color: #aaa; font-size: 0.8em; margin-top: 5px; cursor: pointer;
            align-self: flex-start; display: flex; gap: 5px; align-items: center;
        }
        .btn-copiar:hover { color: var(--primary); }

        /* --- RODAP√â --- */
        footer {
            background: var(--bg-chat);
            padding: 10px 15px 15px 15px;
            border-top: 1px solid #eee;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }

        .topicos-rapidos { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .topicos-rapidos::-webkit-scrollbar { display: none; }

        .chip {
            background: var(--primary); opacity: 0.9; color: white;
            padding: 8px 15px; border-radius: 20px; font-size: 0.9em;
            white-space: nowrap; border: none; cursor: pointer;
        }

        .input-wrapper { display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 30px; font-size: 1em; outline: none; }
        input:focus { border-color: var(--primary); }

        #btn-mic {
            background: #ff7675; color: white; width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 1.2em;
            cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow);
        }
        #btn-mic.ouvindo { background: #00b894; animation: pulse 1.5s infinite; }

        .btn-send {
            background: var(--primary); color: white; padding: 0 25px; height: 50px; border-radius: 30px; border: none;
            font-weight: bold; cursor: pointer; box-shadow: var(--shadow);
        }

        /* --- TELAS E ANIMA√á√ïES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); color: white; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
            box-sizing: border-box;
        }
        .oculto { display: none !important; }
        .card-aviso { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); max-width: 500px; }
        .btn-grande { background: white; color: var(--primary); padding: 15px 40px; border-radius: 30px; border: none; font-size: 1.2em; font-weight: bold; margin-top: 20px; cursor: pointer; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="overlay-menu" onclick="fecharMenu()"></div>
    <nav id="side-menu">
        <div class="menu-titulo">Configura√ß√µes</div>
        <button class="menu-item" onclick="ajustarFonte(1)">üìù Aumentar Letra</button>
        <button class="menu-item" onclick="ajustarFonte(-1)">ü§è Diminuir Letra</button>
        <button class="menu-item" onclick="alternarContraste()">üåì Alto Contraste</button>
        <button class="menu-item" id="btn-som-menu" onclick="alternarSom()">üîá Ativar Voz</button>
        <div class="menu-divider"></div>
        <div class="menu-titulo">A√ß√µes</div>
        <button class="menu-item" onclick="exportarConversa()">üì• Salvar Conversa</button>
        <button class="menu-item" onclick="limparChat()" style="color: #d63031;">üóëÔ∏è Limpar Tudo</button>
    </nav>

    <div id="tela-boas-vindas" class="modal-overlay">
        <div class="card-aviso">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" width="80" style="margin-bottom:20px">
            <h1>Cici</h1>
            <p>Assistente inteligente, acess√≠vel e paciente.</p>
            <button class="btn-grande" onclick="irParaAviso()">Come√ßar</button>
        </div>
    </div>

    <div id="tela-aviso" class="modal-overlay oculto">
        <div class="card-aviso">
            <h2>Avisos Importantes</h2>
            <p>Sou uma IA. Posso cometer erros. N√£o compartilhe senhas ou dados banc√°rios.</p>
            <button class="btn-grande" onclick="irParaChat()">Entendi</button>
            <div style="margin-top:20px; font-size:0.8em;">
                <a href="https://termos.orpheostudio.com.br" style="color:white">Termos</a> | 
                <a href="https://politicas.orpheostudio.com.br" style="color:white">Pol√≠ticas</a>
            </div>
        </div>
    </div>

    <div id="tela-app" class="oculto" style="display:flex; flex-direction:column; height:100%">
        <header>
            <button class="menu-btn" onclick="abrirMenu()">‚ò∞</button>
            <div class="logo-area">ü§ñ Cici</div>
            <div style="width:40px"></div>
        </header>

        <div id="chat-container"></div>

        <footer>
            <div class="topicos-rapidos">
                <button class="chip" onclick="usarChip('Explica-me como se eu tivesse 5 anos:')">üë∂ Explicar Simples</button>
                <button class="chip" onclick="usarChip('Como usar o WhatsApp?')">üì± WhatsApp</button>
                <button class="chip" onclick="usarChip('Receita saud√°vel e barata')">ü•ó Receita</button>
                <button class="chip" onclick="usarChip('Conte uma piada leve')">üòÇ Piada</button>
            </div>
            <div class="input-wrapper">
                <button id="btn-mic" onclick="ativarMicrofone()">üé§</button>
                <input type="text" id="entradaUsuario" placeholder="Escreva aqui..." aria-label="Mensagem">
                <button class="btn-send" onclick="enviarMensagem()">Enviar</button>
            </div>
        </footer>
    </div>

    <script>
        // --- CONFIGURA√á√ïES (PREENCHA SUAS CHAVES) ---
        const MISTRAL_API_KEY = 'SUA_CHAVE_API_MISTRAL_AQUI'; 
        const SUPABASE_URL = 'SUA_URL_SUPABASE_AQUI';
        const SUPABASE_KEY = 'SUA_CHAVE_ANON_SUPABASE_AQUI';

        // --- ESTADO DO APP ---
        let somAtivado = false;
        let tamanhoFonte = 18;
        let historicoConversa = []; // Mem√≥ria de curto prazo para a API
        let supabase = (SUPABASE_URL !== 'SUA_URL_SUPABASE_AQUI') ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

        // Configura√ß√µes do Marked (Markdown)
        marked.setOptions({ breaks: true }); 

        window.onload = () => {
            carregarHistorico(); // Carrega do LocalStorage para a tela
            if(localStorage.getItem('altoContraste') === 'true') document.body.classList.add('alto-contraste');
        };

        // --- NAVEGA√á√ÉO ---
        function abrirMenu() { document.getElementById('side-menu').classList.add('aberto'); document.getElementById('overlay-menu').classList.add('aberto'); }
        function fecharMenu() { document.getElementById('side-menu').classList.remove('aberto'); document.getElementById('overlay-menu').classList.remove('aberto'); }
        function irParaAviso() { document.getElementById('tela-boas-vindas').classList.add('oculto'); document.getElementById('tela-aviso').classList.remove('oculto'); }
        function irParaChat() { 
            document.getElementById('tela-aviso').classList.add('oculto'); 
            document.getElementById('tela-app').classList.remove('oculto');
            if(document.getElementById("chat-container").children.length === 0) adicionarMsg("Ol√°! Eu sou a Cici. Como posso ajudar hoje?", "cici", false);
        }

        // --- FUN√á√ïES UI ---
        function ajustarFonte(v) {
            tamanhoFonte = Math.max(14, Math.min(32, tamanhoFonte + v));
            document.documentElement.style.setProperty('--font-size', tamanhoFonte + 'px');
        }
        function alternarContraste() {
            document.body.classList.toggle('alto-contraste');
            localStorage.setItem('altoContraste', document.body.classList.contains('alto-contraste'));
            fecharMenu();
        }
        function alternarSom() {
            somAtivado = !somAtivado;
            const btn = document.getElementById('btn-som-menu');
            btn.innerText = somAtivado ? "üîä Voz Ativada" : "üîá Ativar Voz";
            if(!somAtivado) window.speechSynthesis.cancel();
            else falar("Voz ativada.");
            fecharMenu();
        }
        function exportarConversa() {
            const historico = JSON.parse(localStorage.getItem('ciciChat') || '[]');
            let texto = "CONVERSA COM A CICI:\n\n" + historico.map(h => `${h.tipo.toUpperCase()}: ${h.txt}`).join("\n\n");
            const blob = new Blob([texto], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'Conversa_Cici.txt';
            a.click();
            fecharMenu();
        }
        function limparChat() {
            if(confirm("Deseja apagar a conversa?")) {
                localStorage.removeItem('ciciChat');
                historicoConversa = [];
                document.getElementById("chat-container").innerHTML = "";
                adicionarMsg("Conversa limpa.", "cici", false);
                fecharMenu();
            }
        }

        // --- L√ìGICA PRINCIPAL (IA COM MEM√ìRIA) ---
        function usarChip(texto) {
            document.getElementById('entradaUsuario').value = texto;
            // Foca no input para o usu√°rio completar se quiser, ou envia direto?
            // Vamos enviar direto para facilitar
            enviarMensagem();
        }

        async function enviarMensagem() {
            const input = document.getElementById("entradaUsuario");
            const texto = input.value.trim();
            if(!texto) return;

            adicionarMsg(texto, "usuario", true);
            input.value = "";
            if(supabase) supabase.from('mensagens').insert({ conteudo: texto, autor: "usuario" });

            // Loading
            const idLoad = "load-" + Date.now();
            const chat = document.getElementById("chat-container");
            const div = document.createElement("div");
            div.id = idLoad; div.className = "mensagem cici fade-in"; div.innerText = "Digitando...";
            chat.appendChild(div); chat.scrollTop = chat.scrollHeight;

            try {
                const resposta = await chamarMistralMemoria(texto);
                document.getElementById(idLoad).remove();
                adicionarMsg(resposta, "cici", true);
                falar(resposta);
                if(supabase) supabase.from('mensagens').insert({ conteudo: resposta, autor: "cici" });
            } catch(e) {
                document.getElementById(idLoad).remove();
                adicionarMsg("Sem internet. Tente novamente.", "cici", false);
                console.error(e);
            }
        }

        function adicionarMsg(textoRaw, tipo, salvar) {
            const chat = document.getElementById("chat-container");
            const wrapper = document.createElement("div");
            wrapper.className = `mensagem-wrapper ${tipo === 'cici' ? 'cici-wrapper' : 'usuario-wrapper'} fade-in`;
            
            // Div da mensagem
            const divMsg = document.createElement("div");
            divMsg.className = `mensagem ${tipo}`;
            
            // Processa Markdown apenas se for Cici, usu√°rio √© texto puro
            if(tipo === 'cici') {
                divMsg.innerHTML = marked.parse(textoRaw);
            } else {
                divMsg.innerText = textoRaw;
            }

            wrapper.appendChild(divMsg);

            // Bot√£o copiar (S√≥ para Cici)
            if(tipo === 'cici') {
                const btnCopy = document.createElement("button");
                btnCopy.className = "btn-copiar";
                btnCopy.innerHTML = "üìã Copiar";
                btnCopy.onclick = () => {
                    navigator.clipboard.writeText(divMsg.innerText);
                    btnCopy.innerText = "‚úÖ Copiado!";
                    setTimeout(() => btnCopy.innerHTML = "üìã Copiar", 2000);
                };
                wrapper.appendChild(btnCopy);
            }

            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;

            if(salvar) {
                const hist = JSON.parse(localStorage.getItem('ciciChat') || '[]');
                hist.push({txt: textoRaw, tipo});
                localStorage.setItem('ciciChat', JSON.stringify(hist));
            }
        }

        async function chamarMistralMemoria(msgUsuario) {
            if(MISTRAL_API_KEY.includes('SUA_CHAVE')) return "‚ö†Ô∏è Configure a API Key no c√≥digo.";
            
            const systemPrompt = `Voc√™ √© a Cici, uma assistente virtual acess√≠vel.
            P√öBLICO: Idosos, PCDs, pessoas leigas.
            ESTILO: Emp√°tico, paciente, claro, use emojis.
            FORMATO: Use Markdown. Use listas (bullet points) para instru√ß√µes. Use Negrito para destacar.`;

            // Constr√≥i o hist√≥rico para enviar a API (√öltimas 6 mensagens para contexto)
            // Recupera do localstorage para garantir sincronia
            const histLocal = JSON.parse(localStorage.getItem('ciciChat') || '[]');
            const ultimasMensagens = histLocal.slice(-6).map(m => ({
                role: m.tipo === 'usuario' ? 'user' : 'assistant',
                content: m.txt
            }));

            // Adiciona a mensagem atual se n√£o estiver salva ainda
            ultimasMensagens.push({ role: "user", content: msgUsuario });

            const payload = {
                model: "mistral-tiny",
                messages: [
                    { role: "system", content: systemPrompt },
                    ...ultimasMensagens
                ]
            };

            const res = await fetch("https://api.mistral.ai/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${MISTRAL_API_KEY}` },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            return data.choices[0].message.content;
        }

        // --- EXTRAS ---
        function ativarMicrofone() {
            const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Rec) return alert("Navegador sem suporte.");
            const mic = new Rec();
            mic.lang = 'pt-BR';
            const btn = document.getElementById('btn-mic');
            mic.onstart = () => btn.classList.add('ouvindo');
            mic.onend = () => btn.classList.remove('ouvindo');
            mic.onresult = e => { document.getElementById('entradaUsuario').value = e.results[0][0].transcript; };
            mic.start();
        }

        function falar(txt) {
            if(!somAtivado) return;
            window.speechSynthesis.cancel();
            // Remove markdown symbols para a fala n√£o ler "asterisco asterisco"
            const textoLimpo = txt.replace(/[*#_]/g, ''); 
            const u = new SpeechSynthesisUtterance(textoLimpo);
            u.lang = "pt-BR";
            window.speechSynthesis.speak(u);
        }

        function carregarHistorico() {
            const hist = JSON.parse(localStorage.getItem('ciciChat') || '[]');
            hist.forEach(h => adicionarMsg(h.txt, h.tipo, false));
        }

        document.getElementById("entradaUsuario").addEventListener("keypress", e => { if(e.key==="Enter") enviarMensagem(); });
    </script>
</body>
</html>
