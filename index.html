<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Cici - Assistente Inteligente</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="description" content="Assistente virtual inteligente, acess√≠vel e inclusiva">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712027.png">

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="text/javascript">
        // CLARITY (Monitoramento)
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tlya8thx8r"); 
    </script>
    
    <style>
        /* --- DESIGN SYSTEM AVAN√áADO --- */
        :root {
            --primary: #6c5ce7; 
            --primary-dark: #4834d4;
            --primary-light: #a29bfe;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --bg-app: #f5f6fa;
            --bg-chat: #ffffff;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-secondary: #636e72;
            --cici-bubble: #a29bfe;
            --cici-text: #ffffff;
            --user-bubble: #fab1a0;
            --user-text: #2d3436;
            --border-color: #dfe6e9;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            --menu-bg: rgba(255, 255, 255, 0.98);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Tema Alto Contraste */
        body.alto-contraste {
            --primary: #000000;
            --primary-dark: #333;
            --primary-light: #555;
            --bg-app: #000000;
            --bg-chat: #000000;
            --bg-card: #1a1a1a;
            --text-main: #ffff00;
            --text-secondary: #ffff00;
            --cici-bubble: #333333;
            --cici-text: #ffff00;
            --user-bubble: #ffff00;
            --user-text: #000000;
            --menu-bg: #1a1a1a;
            --border-color: #ffff00;
            --shadow-sm: none;
            --shadow-md: 0 0 0 2px #ffff00;
            --shadow-lg: 0 0 0 3px #ffff00;
        }

        /* Tema Escuro */
        body.tema-escuro:not(.alto-contraste) {
            --primary: #a29bfe;
            --primary-dark: #6c5ce7;
            --bg-app: #1e1e1e;
            --bg-chat: #2d2d2d;
            --bg-card: #2d2d2d;
            --text-main: #e0e0e0;
            --text-secondary: #b0b0b0;
            --cici-bubble: #6c5ce7;
            --user-bubble: #fab1a0;
            --border-color: #444;
            --menu-bg: rgba(45, 45, 45, 0.98);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            overflow: hidden;
            transition: var(--transition);
        }

        /* --- ACESSIBILIDADE --- */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 1000;
        }
        .skip-link:focus {
            top: 0;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }

        /* --- FORMATA√á√ÉO MARKDOWN --- */
        .mensagem p { margin: 8px 0; line-height: 1.6; }
        .mensagem p:first-child { margin-top: 0; }
        .mensagem p:last-child { margin-bottom: 0; }
        .mensagem ul, .mensagem ol { margin: 10px 0; padding-left: 24px; line-height: 1.8; }
        .mensagem li { margin: 6px 0; }
        .mensagem strong { font-weight: 800; color: var(--primary); }
        .mensagem em { font-style: italic; opacity: 0.9; }
        .mensagem code { 
            background: rgba(0,0,0,0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .mensagem pre {
            background: rgba(0,0,0,0.05);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .mensagem pre code {
            background: none;
            padding: 0;
        }
        .mensagem a { 
            color: inherit; 
            text-decoration: underline;
            font-weight: 600;
        }
        .mensagem h1, .mensagem h2, .mensagem h3 {
            margin: 16px 0 8px 0;
            font-weight: 800;
        }
        .mensagem blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 16px;
            margin: 12px 0;
            opacity: 0.9;
        }

        /* --- CABE√áALHO --- */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-md);
            z-index: 20;
            position: relative;
        }

        .menu-btn, .header-action {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.3em;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .menu-btn:hover, .header-action:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .menu-btn:active, .header-action:active {
            transform: scale(0.95);
        }

        .logo-area {
            font-size: 1.4em;
            font-weight: 800;
            display: flex;
            gap: 8px;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* --- MENU LATERAL --- */
        #overlay-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 25;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        #overlay-menu.aberto {
            opacity: 1;
            pointer-events: all;
        }

        #side-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 300px;
            height: 100%;
            background: var(--menu-bg);
            z-index: 30;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            overflow-y: auto;
        }
        #side-menu.aberto {
            left: 0;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .menu-close {
            background: var(--danger);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-item {
            background: none;
            border: 2px solid transparent;
            color: var(--text-main);
            padding: 14px 16px;
            text-align: left;
            font-size: 0.95em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            position: relative;
        }
        .menu-item:hover {
            background-color: var(--primary);
            color: white;
            transform: translateX(4px);
        }
        .menu-item:active {
            transform: translateX(2px);
        }
        .menu-item.ativo {
            background-color: var(--primary-light);
            color: white;
        }

        .menu-titulo {
            font-size: 0.85em;
            font-weight: bold;
            margin: 16px 0 8px 0;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
            opacity: 0.5;
        }

        .toggle-switch {
            width: 48px;
            height: 26px;
            background: var(--border-color);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            margin-left: auto;
        }
        .toggle-switch.ativo {
            background: var(--success);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: var(--transition);
        }
        .toggle-switch.ativo::after {
            left: 25px;
        }

        /* --- √ÅREA DE CHAT --- */
        #chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--bg-chat);
            scroll-behavior: smooth;
        }

        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .mensagem-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cici-wrapper {
            align-self: flex-start;
        }
        .usuario-wrapper {
            align-self: flex-end;
            align-items: flex-end;
        }

        .mensagem {
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.6;
            box-shadow: var(--shadow-sm);
            word-wrap: break-word;
            position: relative;
        }

        .cici {
            background: linear-gradient(135deg, var(--cici-bubble) 0%, var(--primary) 100%);
            color: var(--cici-text);
            border-bottom-left-radius: 4px;
        }

        .usuario {
            background-color: var(--user-bubble);
            color: var(--user-text);
            border-bottom-right-radius: 4px;
        }

        .mensagem-hora {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 4px;
        }

        .mensagem-acoes {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-acao {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
            transition: var(--transition);
        }
        .btn-acao:hover {
            background: rgba(0,0,0,0.05);
            color: var(--primary);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--cici-text);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* --- SUGEST√ïES R√ÅPIDAS --- */
        .sugestoes-container {
            padding: 12px 20px;
            background: var(--bg-chat);
            border-top: 1px solid var(--border-color);
        }

        .sugestoes-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
        }
        .sugestoes-scroll::-webkit-scrollbar {
            height: 4px;
        }
        .sugestoes-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .chip {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            white-space: nowrap;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }
        .chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .chip:active {
            transform: translateY(0);
        }

        /* --- RODAP√â / INPUT --- */
        footer {
            background: var(--bg-chat);
            padding: 16px 20px 20px;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            position: relative;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        input {
            width: 100%;
            padding: 14px 50px 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-main);
            transition: var(--transition);
        }
        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }
        input::placeholder {
            color: var(--text-secondary);
        }

        .input-contador {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75em;
            color: var(--text-secondary);
            pointer-events: none;
        }

        #btn-mic {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white;
            width: 52px;
            height: 52px;
            min-width: 52px;
            border-radius: 50%;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }
        #btn-mic:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        #btn-mic:active {
            transform: scale(0.95);
        }
        #btn-mic.ouvindo {
            background: linear-gradient(135deg, var(--success) 0%, #00b894 100%);
            animation: pulse 1.5s infinite;
        }

        .btn-send {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0 28px;
            height: 52px;
            border-radius: 26px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            font-size: 1em;
            white-space: nowrap;
        }
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .btn-send:active {
            transform: translateY(0);
        }
        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* --- TELAS INICIAIS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
        }

        .card-aviso {
            background: rgba(255,255,255,0.15);
            padding: 40px 32px;
            border-radius: 24px;
            backdrop-filter: blur(20px);
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-aviso h1 {
            font-size: 2.5em;
            margin: 16px 0;
        }

        .card-aviso p {
            font-size: 1.1em;
            line-height: 1.6;
            opacity: 0.95;
            margin: 12px 0;
        }

        .btn-grande {
            background: white;
            color: var(--primary);
            padding: 16px 48px;
            border-radius: 30px;
            border: none;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }
        .btn-grande:hover {
            transform: scale(1.05);
        }
        .btn-grande:active {
            transform: scale(0.95);
        }

        .links-footer {
            margin-top: 24px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        .links-footer a {
            color: white;
            text-decoration: none;
            margin: 0 8px;
            font-weight: 600;
        }

        /* --- NOTIFICA√á√ïES TOAST --- */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-main);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 250px;
            max-width: 90%;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border-color);
        }
        .toast.mostrar {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.sucesso {
            border-color: var(--success);
        }
        .toast.erro {
            border-color: var(--danger);
        }
        .toast.aviso {
            border-color: var(--warning);
        }

        /* --- UTILIT√ÅRIOS --- */
        .oculto {
            display: none !important;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.15);
            }
        }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .mensagem-wrapper {
                max-width: 90%;
            }
            .logo-area {
                font-size: 1.2em;
            }
            .btn-send {
                padding: 0 20px;
                font-size: 0.9em;
            }
            #side-menu {
                width: 280px;
                left: -280px;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 0 12px;
            }
            #chat-container {
                padding: 12px;
            }
            footer {
                padding: 12px;
            }
            .chip {
                font-size: 0.85em;
                padding: 8px 14px;
            }
        }

        /* --- MODO LEITURA FACILITADA --- */
        body.leitura-facilitada {
            font-size: 20px;
        }
        body.leitura-facilitada .mensagem {
            line-height: 2;
            letter-spacing: 0.5px;
        }
        body.leitura-facilitada strong {
            font-size: 1.1em;
        }

        /* --- ANIMA√á√ÉO DE CARREGAMENTO --- */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid var(--border-color);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Link de Acessibilidade -->
    <a href="#chat-container" class="skip-link">Pular para o chat</a>

    <!-- Overlay do Menu -->
    <div id="overlay-menu" onclick="fecharMenu()" role="button" tabindex="0" aria-label="Fechar menu"></div>

    <!-- Menu Lateral -->
    <nav id="side-menu" role="navigation" aria-label="Menu de configura√ß√µes">
        <div class="menu-header">
            <h2 style="margin:0; font-size:1.3em;">‚öôÔ∏è Configura√ß√µes</h2>
            <button class="menu-close" onclick="fecharMenu()" aria-label="Fechar menu">‚úï</button>
        </div>

        <div class="menu-titulo">Apar√™ncia</div>
        <button class="menu-item" onclick="alternarTemaEscuro()">
            <span id="icone-tema">üåô</span>
            <span id="texto-tema">Modo Escuro</span>
            <div class="toggle-switch" id="toggle-tema"></div>
        </button>
        <button class="menu-item" onclick="alternarContraste()">
            <span>üåì</span>
            <span>Alto Contraste</span>
            <div class="toggle-switch" id="toggle-contraste"></div>
        </button>
        <button class="menu-item" onclick="alternarLeituraFacilitada()">
            <span>üìñ</span>
            <span>Leitura Facilitada</span>
            <div class="toggle-switch" id="toggle-leitura"></div>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">Tamanho do Texto</div>
        <button class="menu-item" onclick="ajustarFonte(2)">
            <span>üîç</span>
            <span>Aumentar Letra</span>
        </button>
        <button class="menu-item" onclick="ajustarFonte(-2)">
            <span>üîé</span>
            <span>Diminuir Letra</span>
        </button>
        <button class="menu-item" onclick="resetarFonte()">
            <span>‚Ü©Ô∏è</span>
            <span>Tamanho Padr√£o</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">√Åudio</div>
        <button class="menu-item" onclick="alternarSom()">
            <span id="icone-som">üîá</span>
            <span id="texto-som">Ativar Voz</span>
            <div class="toggle-switch" id="toggle-som"></div>
        </button>
        <button class="menu-item" onclick="ajustarVelocidadeVoz(-0.2)">
            <span>üê¢</span>
            <span>Voz Mais Lenta</span>
        </button>
        <button class="menu-item" onclick="ajustarVelocidadeVoz(0.2)">
            <span>üêá</span>
            <span>Voz Mais R√°pida</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">A√ß√µes</div>
        <button class="menu-item" onclick="exportarConversa()">
            <span>üíæ</span>
            <span>Salvar Conversa</span>
        </button>
        <button class="menu-item" onclick="compartilharConversa()">
            <span>üì§</span>
            <span>Compartilhar</span>
        </button>
        <button class="menu-item" onclick="imprimirConversa()">
            <span>üñ®Ô∏è</span>
            <span>Imprimir</span>
        </button>
        <button class="menu-item" onclick="limparChat()" style="color: var(--danger);">
            <span>üóëÔ∏è</span>
            <span>Limpar Conversa</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">Ajuda</div>
        <button class="menu-item" onclick="mostrarAjuda()">
            <span>‚ùì</span>
            <span>Como Usar</span>
        </button>
        <button class="menu-item" onclick="mostrarAtalhos()">
            <span>‚å®Ô∏è</span>
            <span>Atalhos de Teclado</span>
        </button>
    </nav>

    <!-- Tela de Boas-Vindas -->
    <div id="tela-boas-vindas" class="modal-overlay">
        <div class="card-aviso">
            <img src="https://i.imgur.com/HvOcuAv.jpeg" 
                 width="100" 
                 alt="Logo Cici"
                 style="margin-bottom:20px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));">
            <h1>üå∏ Cici</h1>
            <p style="font-size: 1.2em; font-weight: 600;">Sua Assistente Inteligente</p>
            <p>Acess√≠vel ‚Ä¢ Paciente ‚Ä¢ Inclusiva</p>
            <button class="btn-grande" onclick="irParaAviso()">Come√ßar Agora</button>
        </div>
    </div>

    <!-- Tela de Avisos -->
    <div id="tela-aviso" class="modal-overlay oculto">
        <div class="card-aviso">
            <h2 style="font-size: 2em; margin-bottom: 20px;">‚ö†Ô∏è Informa√ß√µes Importantes</h2>
            <div style="text-align: left; margin: 20px 0;">
                <p><strong>‚úì</strong> Sou uma assistente de IA e posso cometer erros</p>
                <p><strong>‚úì</strong> N√£o compartilhe senhas ou dados banc√°rios</p>
                <p><strong>‚úì</strong> Verifique informa√ß√µes importantes com profissionais</p>
                <p><strong>‚úì</strong> Suas conversas s√£o salvas localmente no seu dispositivo</p>
            </div>
            <button class="btn-grande" onclick="irParaChat()">Entendi e Aceito</button>
            <div class="links-footer">
                <a href="https://termos.orpheostudio.com.br" target="_blank">Termos de Uso</a> | 
                <a href="https://politicas.orpheostudio.com.br" target="_blank">Pol√≠tica de Privacidade</a>
            </div>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="tela-app" class="oculto" style="display:flex; flex-direction:column; height:100%">
        <header>
            <button class="menu-btn" onclick="abrirMenu()" aria-label="Abrir menu">‚ò∞</button>
            <div class="logo-area">
                <span>üå∏ Cici</span>
                <span class="status-indicator" aria-label="Online"></span>
            </div>
            <button class="header-action" onclick="novaConversa()" aria-label="Nova conversa" title="Nova conversa">
                ‚ûï
            </button>
        </header>

        <div id="chat-container" role="main" aria-live="polite" aria-label="√Årea de conversa"></div>

        <div class="sugestoes-container">
            <div class="sugestoes-scroll" id="chips-sugestoes">
                <button class="chip" onclick="usarChip('Explica de forma bem simples:')">
                    <span>üéØ</span> Explica√ß√£o Simples
                </button>
                <button class="chip" onclick="usarChip('Como usar o WhatsApp?')">
                    <span>üì±</span> WhatsApp
                </button>
                <button class="chip" onclick="usarChip('Receita saud√°vel e econ√¥mica')">
                    <span>ü•ó</span> Receitas
                </button>
                <button class="chip" onclick="usarChip('Exerc√≠cios leves para fazer em casa')">
                    <span>üèÉ</span> Exerc√≠cios
                </button>
                <button class="chip" onclick="usarChip('Conte uma hist√≥ria inspiradora')">
                    <span>üìö</span> Hist√≥ria
                </button>
                <button class="chip" onclick="usarChip('Como melhorar minha mem√≥ria?')">
                    <span>üß†</span> Dicas de Sa√∫de
                </button>
            </div>
        </div>

        <footer>
            <div class="input-wrapper">
                <button id="btn-mic" 
                        onclick="ativarMicrofone()" 
                        aria-label="Ativar microfone"
                        title="Clique para falar">üé§</button>
                
                <div class="input-container">
                    <input type="text" 
                           id="entradaUsuario" 
                           placeholder="Digite sua mensagem..." 
                           aria-label="Campo de mensagem"
                           maxlength="2000"
                           autocomplete="off">
                    <span class="input-contador" id="contador-chars">0/2000</span>
                </div>
                
                <button class="btn-send" 
                        onclick="enviarMensagem()" 
                        id="btn-enviar"
                        aria-label="Enviar mensagem">
                    Enviar
                </button>
            </div>
        </footer>
    </div>

    <!-- Container para Toasts -->
    <div id="toast-container"></div>

    <script>
        // ========================================
        // CONFIGURA√á√ïES E ESTADO GLOBAL
        // ========================================
        
        const CONFIG = {
            MISTRAL_API_KEY: 'NFuAj8PYUPcaf6tA1BjbyXuIeSjSA4sW',
            MAX_HISTORICO: 10,
            MAX_CHARS: 2000,
            VELOCIDADE_VOZ_PADRAO: 1.0,
            TYPING_DELAY: 1500
        };

        let estado = {
            somAtivado: false,
            velocidadeVoz: CONFIG.VELOCIDADE_VOZ_PADRAO,
            tamanhoFonte: 16,
            temaEscuro: false,
            altoContraste: false,
            leituraFacilitada: false,
            conversaAtual: [],
            aguardandoResposta: false
        };

        // ========================================
        // INICIALIZA√á√ÉO
        // ========================================
        
        window.onload = () => {
            carregarConfiguracoes();
            carregarHistorico();
            configurarEventos();
            aplicarConfiguracoes();
            verificarSuporteFuncionalidades();
        };

        function carregarConfiguracoes() {
            const configs = JSON.parse(localStorage.getItem('ciciConfigs') || '{}');
            estado = { ...estado, ...configs };
            
            if (localStorage.getItem('altoContraste') === 'true') {
                estado.altoContraste = true;
            }
        }

        function salvarConfiguracoes() {
            localStorage.setItem('ciciConfigs', JSON.stringify(estado));
        }

        function aplicarConfiguracoes() {
            // Tema
            if (estado.temaEscuro) {
                document.body.classList.add('tema-escuro');
                document.getElementById('toggle-tema').classList.add('ativo');
                document.getElementById('icone-tema').textContent = '‚òÄÔ∏è';
                document.getElementById('texto-tema').textContent = 'Modo Claro';
            }
            
            // Alto Contraste
            if (estado.altoContraste) {
                document.body.classList.add('alto-contraste');
                document.getElementById('toggle-contraste').classList.add('ativo');
            }
            
            // Leitura Facilitada
            if (estado.leituraFacilitada) {
                document.body.classList.add('leitura-facilitada');
                document.getElementById('toggle-leitura').classList.add('ativo');
            }
            
            // Som
            if (estado.somAtivado) {
                document.getElementById('toggle-som').classList.add('ativo');
                document.getElementById('icone-som').textContent = 'üîä';
                document.getElementById('texto-som').textContent = 'Desativar Voz';
            }
            
            // Fonte
            document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
        }

        function configurarEventos() {
            const input = document.getElementById('entradaUsuario');
            
            // Enter para enviar
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensagem();
                }
            });
            
            // Contador de caracteres
            input.addEventListener('input', () => {
                const contador = document.getElementById('contador-chars');
                contador.textContent = `${input.value.length}/${CONFIG.MAX_CHARS}`;
                
                if (input.value.length > CONFIG.MAX_CHARS * 0.9) {
                    contador.style.color = 'var(--danger)';
                } else {
                    contador.style.color = 'var(--text-secondary)';
                }
            });

            // Atalhos de teclado
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K = Foco no input
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    input.focus();
                }
                
                // Ctrl/Cmd + L = Limpar chat
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    limparChat();
                }
                
                // Ctrl/Cmd + S = Salvar conversa
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    exportarConversa();
                }

                // Esc = Fechar menu
                if (e.key === 'Escape') {
                    fecharMenu();
                }
            });
        }

        function verificarSuporteFuncionalidades() {
            // Verifica Web Speech API
            const temReconhecimentoVoz = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
            const temSinteseVoz = 'speechSynthesis' in window;
            
            if (!temReconhecimentoVoz) {
                document.getElementById('btn-mic').style.display = 'none';
                console.warn('Reconhecimento de voz n√£o suportado');
            }
            
            if (!temSinteseVoz) {
                console.warn('S√≠ntese de voz n√£o suportada');
            }
        }

        // ========================================
        // FUN√á√ïES DE NAVEGA√á√ÉO ENTRE TELAS
        // ========================================
        
        function irParaAviso() {
            document.getElementById('tela-boas-vindas').classList.add('oculto');
            document.getElementById('tela-aviso').classList.remove('oculto');
        }

        function irParaChat() {
            document.getElementById('tela-aviso').classList.add('oculto');
            document.getElementById('tela-app').classList.remove('oculto');
            
            const chat = document.getElementById('chat-container');
            if (chat.children.length === 0) {
                setTimeout(() => {
                    adicionarMensagem(
                        "üëã Ol√°! Eu sou a **Cici**, sua assistente virtual.\n\n" +
                        "Estou aqui para ajudar com:\n" +
                        "- üí¨ Conversas e d√∫vidas\n" +
                        "- üì± Tecnologia e aplicativos\n" +
                        "- üç≥ Receitas e dicas do dia a dia\n" +
                        "- üí™ Sa√∫de e bem-estar\n" +
                        "- üìö Aprendizado e explica√ß√µes\n\n" +
                        "Como posso ajudar voc√™ hoje?",
                        'cici',
                        false
                    );
                }, 300);
            }
        }

        // ========================================
        // NAVEGA√á√ÉO E MENU
        // ========================================
        
        function abrirMenu() {
            document.getElementById('side-menu').classList.add('aberto');
            document.getElementById('overlay-menu').classList.add('aberto');
            document.body.style.overflow = 'hidden';
        }

        function fecharMenu() {
            document.getElementById('side-menu').classList.remove('aberto');
            document.getElementById('overlay-menu').classList.remove('aberto');
            document.body.style.overflow = '';
        }

        function irParaAviso() {
            document.getElementById('tela-boas-vindas').classList.add('oculto');
            document.getElementById('tela-aviso').classList.remove('oculto');
        }

        function irParaChat() {
            document.getElementById('tela-aviso').classList.add('oculto');
            document.getElementById('tela-app').classList.remove('oculto');
            
            const chat = document.getElementById('chat-container');
            if (chat.children.length === 0) {
                setTimeout(() => {
                    adicionarMensagem(
                        "üëã Ol√°! Eu sou a **Cici**, sua assistente virtual.\n\n" +
                        "Estou aqui para ajudar com:\n" +
                        "- üí¨ Conversas e d√∫vidas\n" +
                        "- üì± Tecnologia e aplicativos\n" +
                        "- üç≥ Receitas e dicas do dia a dia\n" +
                        "- üí™ Sa√∫de e bem-estar\n" +
                        "- üìö Aprendizado e explica√ß√µes\n\n" +
                        "Como posso ajudar voc√™ hoje?",
                        'cici',
                        false
                    );
                }, 300);
            }
        }

        function novaConversa() {
            if (confirm('Deseja iniciar uma nova conversa? A conversa atual ser√° salva.')) {
                limparChat();
                irParaChat();
                mostrarToast('Nova conversa iniciada!', 'sucesso');
            }
        }

        // ========================================
        // CONFIGURA√á√ïES DE APAR√äNCIA
        // ========================================
        
        function alternarTemaEscuro() {
            estado.temaEscuro = !estado.temaEscuro;
            document.body.classList.toggle('tema-escuro');
            
            const toggle = document.getElementById('toggle-tema');
            const icone = document.getElementById('icone-tema');
            const texto = document.getElementById('texto-tema');
            
            if (estado.temaEscuro) {
                toggle.classList.add('ativo');
                icone.textContent = '‚òÄÔ∏è';
                texto.textContent = 'Modo Claro';
            } else {
                toggle.classList.remove('ativo');
                icone.textContent = 'üåô';
                texto.textContent = 'Modo Escuro';
            }
            
            salvarConfiguracoes();
            mostrarToast('Tema alterado!', 'sucesso');
        }

        function alternarContraste() {
            estado.altoContraste = !estado.altoContraste;
            document.body.classList.toggle('alto-contraste');
            document.getElementById('toggle-contraste').classList.toggle('ativo');
            localStorage.setItem('altoContraste', estado.altoContraste);
            salvarConfiguracoes();
            mostrarToast('Alto contraste ' + (estado.altoContraste ? 'ativado' : 'desativado'), 'sucesso');
        }

        function alternarLeituraFacilitada() {
            estado.leituraFacilitada = !estado.leituraFacilitada;
            document.body.classList.toggle('leitura-facilitada');
            document.getElementById('toggle-leitura').classList.toggle('ativo');
            salvarConfiguracoes();
            mostrarToast('Leitura facilitada ' + (estado.leituraFacilitada ? 'ativada' : 'desativada'), 'sucesso');
        }

        function ajustarFonte(incremento) {
            estado.tamanhoFonte = Math.max(12, Math.min(28, estado.tamanhoFonte + incremento));
            document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
            salvarConfiguracoes();
            mostrarToast(`Tamanho: ${estado.tamanhoFonte}px`, 'sucesso');
        }

        function resetarFonte() {
            estado.tamanhoFonte = 16;
            document.documentElement.style.fontSize = '16px';
            salvarConfiguracoes();
            mostrarToast('Tamanho padr√£o restaurado', 'sucesso');
        }

        // ========================================
        // CONFIGURA√á√ïES DE √ÅUDIO
        // ========================================
        
        function alternarSom() {
            estado.somAtivado = !estado.somAtivado;
            
            const toggle = document.getElementById('toggle-som');
            const icone = document.getElementById('icone-som');
            const texto = document.getElementById('texto-som');
            
            if (estado.somAtivado) {
                toggle.classList.add('ativo');
                icone.textContent = 'üîä';
                texto.textContent = 'Desativar Voz';
                falar('Voz ativada com sucesso!');
            } else {
                toggle.classList.remove('ativo');
                icone.textContent = 'üîá';
                texto.textContent = 'Ativar Voz';
                window.speechSynthesis.cancel();
            }
            
            salvarConfiguracoes();
        }

        function ajustarVelocidadeVoz(incremento) {
            estado.velocidadeVoz = Math.max(0.5, Math.min(2.0, estado.velocidadeVoz + incremento));
            salvarConfiguracoes();
            
            const velocidadeTexto = estado.velocidadeVoz === 1.0 ? 'normal' : 
                                   estado.velocidadeVoz < 1.0 ? 'lenta' : 'r√°pida';
            
            mostrarToast(`Velocidade da voz: ${velocidadeTexto}`, 'sucesso');
            falar('Teste de velocidade da voz');
        }

        function falar(texto) {
            if (!estado.somAtivado || !('speechSynthesis' in window)) return;
            
            window.speechSynthesis.cancel();
            
            // Remove markdown e HTML para fala mais limpa
            const textoLimpo = texto
                .replace(/[*_#`]/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/\n+/g, '. ');
            
            const utterance = new SpeechSynthesisUtterance(textoLimpo);
            utterance.lang = 'pt-BR';
            utterance.rate = estado.velocidadeVoz;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            window.speechSynthesis.speak(utterance);
        }

        function ativarMicrofone() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                mostrarToast('Seu navegador n√£o suporta reconhecimento de voz', 'erro');
                return;
            }
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            const btnMic = document.getElementById('btn-mic');
            
            recognition.onstart = () => {
                btnMic.classList.add('ouvindo');
                mostrarToast('üé§ Estou ouvindo...', 'aviso');
            };
            
            recognition.onend = () => {
                btnMic.classList.remove('ouvindo');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('entradaUsuario').value = transcript;
                document.getElementById('entradaUsuario').focus();
                mostrarToast('‚úì Texto capturado!', 'sucesso');
            };
            
            recognition.onerror = (event) => {
                btnMic.classList.remove('ouvindo');
                let mensagem = 'Erro ao capturar voz';
                
                if (event.error === 'no-speech') {
                    mensagem = 'Nenhuma fala detectada';
                } else if (event.error === 'not-allowed') {
                    mensagem = 'Permiss√£o de microfone negada';
                }
                
                mostrarToast(mensagem, 'erro');
            };
            
            try {
                recognition.start();
            } catch (e) {
                mostrarToast('Erro ao iniciar microfone', 'erro');
                console.error(e);
            }
        }

        // ========================================
        // L√ìGICA PRINCIPAL DO CHAT
        // ========================================
        
        function usarChip(texto) {
            document.getElementById('entradaUsuario').value = texto + ' ';
            document.getElementById('entradaUsuario').focus();
        }

        async function enviarMensagem() {
            const input = document.getElementById('entradaUsuario');
            const texto = input.value.trim();
            
            if (!texto || estado.aguardandoResposta) return;
            
            if (CONFIG.MISTRAL_API_KEY.includes('SUA_CHAVE')) {
                mostrarToast('‚ö†Ô∏è Configure a API Key no c√≥digo para usar a IA', 'erro');
                return;
            }
            
            // Adiciona mensagem do usu√°rio
            adicionarMensagem(texto, 'usuario', true);
            input.value = '';
            document.getElementById('contador-chars').textContent = '0/2000';
            
            estado.aguardandoResposta = true;
            document.getElementById('btn-enviar').disabled = true;
            
            // Mostra indicador de digita√ß√£o
            const loadingId = mostrarDigitando();
            
            try {
                const resposta = await chamarIA(texto);
                removerDigitando(loadingId);
                
                adicionarMensagem(resposta, 'cici', true);
                falar(resposta);
                
            } catch (erro) {
                removerDigitando(loadingId);
                console.error('Erro:', erro);
                
                let mensagemErro = 'üòï Desculpe, ocorreu um erro. ';
                
                if (!navigator.onLine) {
                    mensagemErro += 'Verifique sua conex√£o com a internet.';
                } else if (erro.message.includes('401')) {
                    mensagemErro += 'Chave de API inv√°lida.';
                } else if (erro.message.includes('429')) {
                    mensagemErro += 'Muitas requisi√ß√µes. Aguarde um momento.';
                } else {
                    mensagemErro += 'Tente novamente em alguns instantes.';
                }
                
                adicionarMensagem(mensagemErro, 'cici', false);
                mostrarToast('Erro ao processar mensagem', 'erro');
            } finally {
                estado.aguardandoResposta = false;
                document.getElementById('btn-enviar').disabled = false;
                input.focus();
            }
        }

        function mostrarDigitando() {
            const id = 'typing-' + Date.now();
            const chat = document.getElementById('chat-container');
            
            const wrapper = document.createElement('div');
            wrapper.id = id;
            wrapper.className = 'mensagem-wrapper cici-wrapper';
            wrapper.style.animation = 'slideIn 0.3s ease-out';
            
            const msg = document.createElement('div');
            msg.className = 'mensagem cici typing-indicator';
            msg.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            wrapper.appendChild(msg);
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
            
            return id;
        }

        function removerDigitando(id) {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => elemento.remove(), 300);
            }
        }

        function adicionarMensagem(textoRaw, tipo, salvar) {
            const chat = document.getElementById('chat-container');
            const agora = new Date();
            const hora = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            // Wrapper principal
            const wrapper = document.createElement('div');
            wrapper.className = `mensagem-wrapper ${tipo === 'cici' ? 'cici-wrapper' : 'usuario-wrapper'}`;
            
            // Div da mensagem
            const divMsg = document.createElement('div');
            divMsg.className = `mensagem ${tipo}`;
            
            // Processa Markdown para Cici
            if (tipo === 'cici') {
                divMsg.innerHTML = marked.parse(textoRaw);
            } else {
                divMsg.textContent = textoRaw;
            }
            
            wrapper.appendChild(divMsg);
            
            // Hora da mensagem
            const divHora = document.createElement('div');
            divHora.className = 'mensagem-hora';
            divHora.textContent = hora;
            wrapper.appendChild(divHora);
            
            // A√ß√µes (apenas para Cici)
            if (tipo === 'cici') {
                const acoesDiv = document.createElement('div');
                acoesDiv.className = 'mensagem-acoes';
                
                // Bot√£o copiar
                const btnCopiar = criarBotaoAcao('üìã', 'Copiar', () => {
                    navigator.clipboard.writeText(divMsg.innerText).then(() => {
                        mostrarToast('Texto copiado!', 'sucesso');
                        btnCopiar.innerHTML = '‚úÖ Copiado';
                        setTimeout(() => btnCopiar.innerHTML = 'üìã Copiar', 2000);
                    });
                });
                
                // Bot√£o ler
                const btnLer = criarBotaoAcao('üîä', 'Ler', () => {
                    falar(textoRaw);
                });
                
                // Bot√£o feedback positivo
                const btnGostei = criarBotaoAcao('üëç', 'Gostei', () => {
                    mostrarToast('Obrigada pelo feedback!', 'sucesso');
                    btnGostei.style.color = 'var(--success)';
                });
                
                acoesDiv.appendChild(btnCopiar);
                acoesDiv.appendChild(btnLer);
                acoesDiv.appendChild(btnGostei);
                
                wrapper.appendChild(acoesDiv);
            }
            
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
            
            // Salva no hist√≥rico
            if (salvar) {
                estado.conversaAtual.push({ texto: textoRaw, tipo, timestamp: agora.toISOString() });
                
                // Mant√©m apenas as √∫ltimas mensagens
                if (estado.conversaAtual.length > CONFIG.MAX_HISTORICO * 2) {
                    estado.conversaAtual = estado.conversaAtual.slice(-CONFIG.MAX_HISTORICO * 2);
                }
                
                localStorage.setItem('ciciChat', JSON.stringify(estado.conversaAtual));
                
                // Salva no Supabase se configurado
                if (supabase) {
                    supabase.from('mensagens').insert({ 
                        conteudo: textoRaw, 
                        autor: tipo,
                        timestamp: agora.toISOString()
                    }).then(result => {
                        if (result.error) {
                            console.warn('Erro ao salvar no Supabase:', result.error);
                        }
                    });
                }
            }
        }

        function criarBotaoAcao(icone, texto, onClick) {
            const btn = document.createElement('button');
            btn.className = 'btn-acao';
            btn.innerHTML = `${icone} ${texto}`;
            btn.onclick = onClick;
            btn.setAttribute('aria-label', texto);
            return btn;
        }

        async function chamarIA(mensagemUsuario) {
            const systemPrompt = `Voc√™ √© a Cici, uma assistente virtual brasileira.

CARACTER√çSTICAS:
- Emp√°tica, paciente e acess√≠vel
- Especializada em ajudar idosos, PCDs e pessoas leigas em tecnologia
- Comunica√ß√£o clara e simples
- Sempre positiva e encorajadora

ESTILO DE RESPOSTA:
- Use linguagem simples e direta
- Use emojis com modera√ß√£o para tornar a conversa amig√°vel
- Formate respostas importantes em Markdown:
  * Use **negrito** para destacar pontos importantes
  * Use listas numeradas ou com marcadores para instru√ß√µes passo a passo
  * Use par√°grafos curtos e bem espa√ßados
- Evite jarg√µes t√©cnicos, mas quando necess√°rio, explique os termos
- Sempre que poss√≠vel, d√™ exemplos pr√°ticos

√ÅREAS DE AJUDA:
- Tecnologia (WhatsApp, aplicativos, celular, computador)
- Sa√∫de e bem-estar
- Receitas e culin√°ria
- Exerc√≠cios e atividades f√≠sicas
- Aprendizado e educa√ß√£o
- Conversa√ß√£o geral

Seja sempre respeitosa e paciente. Se n√£o souber algo, seja honesta e sugira buscar ajuda profissional quando apropriado.`;

            // Prepara hist√≥rico (√∫ltimas 6 mensagens)
            const historico = estado.conversaAtual
                .slice(-6)
                .map(m => ({
                    role: m.tipo === 'usuario' ? 'user' : 'assistant',
                    content: m.texto
                }));
            
            historico.push({
                role: 'user',
                content: mensagemUsuario
            });
            
            const payload = {
                model: 'mistral-tiny',
                messages: [
                    { role: 'system', content: systemPrompt },
                    ...historico
                ],
                temperature: 0.7,
                max_tokens: 1000
            };
            
            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.MISTRAL_API_KEY}`
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // ========================================
        // GERENCIAMENTO DE HIST√ìRICO
        // ========================================
        
        function carregarHistorico() {
            const historico = JSON.parse(localStorage.getItem('ciciChat') || '[]');
            estado.conversaAtual = historico;
            
            historico.forEach(msg => {
                adicionarMensagem(msg.texto, msg.tipo, false);
            });
        }

        function limparChat() {
            if (!confirm('üóëÔ∏è Deseja realmente limpar toda a conversa?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            localStorage.removeItem('ciciChat');
            estado.conversaAtual = [];
            document.getElementById('chat-container').innerHTML = '';
            
            setTimeout(() => {
                adicionarMensagem(
                    '‚ú® Conversa limpa! Estou pronta para uma nova conversa.',
                    'cici',
                    false
                );
            }, 300);
            
            fecharMenu();
            mostrarToast('Conversa limpa com sucesso', 'sucesso');
        }

        // ========================================
        // EXPORTA√á√ÉO E COMPARTILHAMENTO
        // ========================================
        
        function exportarConversa() {
            const historico = estado.conversaAtual;
            
            if (historico.length === 0) {
                mostrarToast('N√£o h√° conversa para exportar', 'aviso');
                return;
            }
            
            const agora = new Date();
            const dataFormatada = agora.toLocaleDateString('pt-BR');
            const horaFormatada = agora.toLocaleTimeString('pt-BR');
            
            let texto = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CONVERSA COM A CICI
Assistente Virtual Inteligente
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Data: ${dataFormatada}
Hora: ${horaFormatada}
Total de mensagens: ${historico.length}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;
            
            historico.forEach((msg, index) => {
                const timestamp = new Date(msg.timestamp).toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const remetente = msg.tipo === 'usuario' ? 'VOC√ä' : 'CICI';
                const separador = msg.tipo === 'usuario' ? '‚ñ∫' : '‚óè';
                
                texto += `[${timestamp}] ${separador} ${remetente}:\n${msg.texto}\n\n`;
                
                if (index < historico.length - 1) {
                    texto += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
                }
            });
            
            texto += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Exportado via Cici - Assistente Virtual
https://cici.net.br
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
            
            const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Conversa_Cici_${agora.getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            fecharMenu();
            mostrarToast('‚úì Conversa salva com sucesso!', 'sucesso');
        }

        function compartilharConversa() {
            const historico = estado.conversaAtual;
            
            if (historico.length === 0) {
                mostrarToast('N√£o h√° conversa para compartilhar', 'aviso');
                return;
            }
            
            let textoCompartilhar = 'Conversa com a Cici:\n\n';
            
            historico.slice(-5).forEach(msg => {
                const remetente = msg.tipo === 'usuario' ? 'Eu' : 'Cici';
                textoCompartilhar += `${remetente}: ${msg.texto}\n\n`;
            });
            
            if (navigator.share) {
                navigator.share({
                    title: 'Conversa com a Cici',
                    text: textoCompartilhar
                }).then(() => {
                    mostrarToast('Compartilhado com sucesso!', 'sucesso');
                }).catch(err => {
                    if (err.name !== 'AbortError') {
                        copiarParaClipboard(textoCompartilhar);
                    }
                });
            } else {
                copiarParaClipboard(textoCompartilhar);
            }
            
            fecharMenu();
        }

        function copiarParaClipboard(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                mostrarToast('Conversa copiada para a √°rea de transfer√™ncia!', 'sucesso');
            }).catch(() => {
                mostrarToast('Erro ao copiar. Tente exportar como arquivo.', 'erro');
            });
        }

        function imprimirConversa() {
            const historico = estado.conversaAtual;
            
            if (historico.length === 0) {
                mostrarToast('N√£o h√° conversa para imprimir', 'aviso');
                return;
            }
            
            const agora = new Date();
            const dataFormatada = agora.toLocaleDateString('pt-BR');
            
            let html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Conversa com Cici - ${dataFormatada}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .cabecalho {
            text-align: center;
            border-bottom: 3px solid #6c5ce7;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .cabecalho h1 {
            color: #6c5ce7;
            margin: 0;
        }
        .mensagem {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            page-break-inside: avoid;
        }
        .usuario {
            background: #fab1a0;
            margin-left: 20%;
        }
        .cici {
            background: #a29bfe;
            color: white;
            margin-right: 20%;
        }
        .remetente {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .timestamp {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
        .rodape {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 0.9em;
            color: #666;
        }
        @media print {
            body { margin: 20px; }
        }
    </style>
</head>
<body>
    <div class="cabecalho">
        <h1>ü§ñ Cici - Assistente Virtual</h1>
        <p>Conversa do dia ${dataFormatada}</p>
        <p>Total de mensagens: ${historico.length}</p>
    </div>
`;
            
            historico.forEach(msg => {
                const timestamp = new Date(msg.timestamp).toLocaleString('pt-BR');
                const remetente = msg.tipo === 'usuario' ? 'üë§ Voc√™' : 'ü§ñ Cici';
                
                html += `
    <div class="mensagem ${msg.tipo}">
        <div class="remetente">${remetente}</div>
        <div>${msg.texto.replace(/\n/g, '<br>')}</div>
        <div class="timestamp">${timestamp}</div>
    </div>
`;
            });
            
            html += `
    <div class="rodape">
        <p>Exportado via Cici - Assistente Virtual Inteligente</p>
        <p>Documento gerado automaticamente</p>
    </div>
</body>
</html>`;
            
            const janelaImpressao = window.open('', '_blank');
            janelaImpressao.document.write(html);
            janelaImpressao.document.close();
            janelaImpressao.focus();
            
            setTimeout(() => {
                janelaImpressao.print();
            }, 500);
            
            fecharMenu();
            mostrarToast('Preparando para impress√£o...', 'sucesso');
        }

        // ========================================
        // SISTEMA DE NOTIFICA√á√ïES TOAST
        // ========================================
        
        function mostrarToast(mensagem, tipo = 'sucesso') {
            const container = document.getElementById('toast-container') || criarContainerToast();
            
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            
            const icones = {
                sucesso: '‚úì',
                erro: '‚úï',
                aviso: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span style="font-size: 1.2em;">${icones[tipo] || '‚Ä¢'}</span>
                <span>${mensagem}</span>
            `;
            
            container.appendChild(toast);
            
            // Anima entrada
            setTimeout(() => toast.classList.add('mostrar'), 10);
            
            // Remove ap√≥s 3 segundos
            setTimeout(() => {
                toast.classList.remove('mostrar');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function criarContainerToast() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
            return container;
        }

        // ========================================
        // AJUDA E TUTORIAIS
        // ========================================
        
        function mostrarAjuda() {
            fecharMenu();
            
            const textoAjuda = `# üìö Como Usar a Cici

## üí¨ Conversar
Basta digitar sua pergunta no campo abaixo e clicar em **Enviar** ou pressionar **Enter**.

## üé§ Usar o Microfone
Clique no bot√£o vermelho do microfone para falar. A Cici vai transformar sua fala em texto!

## üîä Ouvir as Respostas
Ative a voz nas configura√ß√µes (‚ò∞ Menu) e a Cici vai ler as respostas para voc√™.

## üéØ Sugest√µes R√°pidas
Use os bot√µes coloridos acima do campo de mensagem para come√ßar conversas rapidamente.

## ‚öôÔ∏è Personalizar
No menu (‚ò∞), voc√™ pode:
- Aumentar ou diminuir o tamanho das letras
- Ativar modo escuro ou alto contraste
- Ajustar a velocidade da voz
- Salvar ou limpar conversas

## üí° Dicas
- Seja claro e espec√≠fico nas perguntas
- Pe√ßa para a Cici explicar de forma mais simples se precisar
- Use frases como "explique passo a passo" para instru√ß√µes detalhadas

**Precisa de mais ajuda?** Pergunte diretamente para a Cici! üòä`;

            adicionarMensagem(textoAjuda, 'cici', false);
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        function mostrarAtalhos() {
            fecharMenu();
            
            const textoAtalhos = `# ‚å®Ô∏è Atalhos de Teclado

Facilite seu uso com estes atalhos:

## Windows / Linux
- **Ctrl + K** - Focar no campo de mensagem
- **Ctrl + L** - Limpar conversa
- **Ctrl + S** - Salvar conversa
- **Enter** - Enviar mensagem
- **Esc** - Fechar menu

## Mac
- **Cmd + K** - Focar no campo de mensagem
- **Cmd + L** - Limpar conversa
- **Cmd + S** - Salvar conversa
- **Enter** - Enviar mensagem
- **Esc** - Fechar menu

üí° **Dica:** Voc√™ tamb√©m pode usar o mouse ou tocar na tela do celular para todas as a√ß√µes!`;

            adicionarMensagem(textoAtalhos, 'cici', false);
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        // ========================================
        // SUGEST√ïES DIN√ÇMICAS
        // ========================================
        
        function atualizarSugestoes() {
            const hora = new Date().getHours();
            const chipsContainer = document.getElementById('chips-sugestoes');
            
            let sugestoes = [];
            
            // Sugest√µes baseadas no hor√°rio
            if (hora >= 6 && hora < 12) {
                sugestoes = [
                    { emoji: '‚òÄÔ∏è', texto: 'Bom dia! Como est√° o clima hoje?', prompt: 'Bom dia! Como est√° o clima hoje?' },
                    { emoji: 'üç≥', texto: 'Receita de Caf√©', prompt: 'Me d√™ uma receita simples para o caf√© da manh√£' },
                    { emoji: 'üßò', texto: 'Exerc√≠cios Matinais', prompt: 'Exerc√≠cios leves para fazer pela manh√£' }
                ];
            } else if (hora >= 12 && hora < 18) {
                sugestoes = [
                    { emoji: 'üçΩÔ∏è', texto: 'Receita para Almo√ßo', prompt: 'Receita saud√°vel e r√°pida para o almo√ßo' },
                    { emoji: 'üí™', texto: 'Dicas de Energia', prompt: 'Como ter mais energia √† tarde?' },
                    { emoji: 'üì±', texto: 'D√∫vida de Celular', prompt: 'Tire minhas d√∫vidas sobre celular' }
                ];
            } else {
                sugestoes = [
                    { emoji: 'üåô', texto: 'Relaxamento', prompt: 'T√©cnicas de relaxamento para dormir melhor' },
                    { emoji: 'üìö', texto: 'Hist√≥ria da Noite', prompt: 'Conte uma hist√≥ria relaxante' },
                    { emoji: 'üéµ', texto: 'M√∫sica Calma', prompt: 'Sugira m√∫sicas calmas para ouvir' }
                ];
            }
            
            // Adiciona sugest√µes gerais
            sugestoes.push(
                { emoji: '‚ùì', texto: 'Como Usar', prompt: 'Como usar este aplicativo?' },
                { emoji: 'üí¨', texto: 'Conversar', prompt: 'Vamos conversar sobre algo interessante' }
            );
            
            // Atualiza o HTML
            chipsContainer.innerHTML = sugestoes.map(s => 
                `<button class="chip" onclick="usarChip('${s.prompt}')">
                    <span>${s.emoji}</span> ${s.texto}
                </button>`
            ).join('');
        }

        // Atualiza sugest√µes a cada 30 minutos
        setInterval(atualizarSugestoes, 1800000);

        // ========================================
        // MELHORIAS DE PERFORMANCE
        // ========================================
        
        // Debounce para eventos frequentes
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Lazy loading de imagens (se houver)
        function lazyLoadImages() {
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            });
            
            images.forEach(img => imageObserver.observe(img));
        }

        // ========================================
        // SERVICE WORKER (PWA)
        // ========================================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Erro ao registrar Service Worker:', error);
                    });
            });
        }

        // ========================================
        // DETEC√á√ÉO DE CONECTIVIDADE
        // ========================================
        
        window.addEventListener('online', () => {
            mostrarToast('‚úì Conex√£o restaurada', 'sucesso');
        });

        window.addEventListener('offline', () => {
            mostrarToast('‚ö†Ô∏è Voc√™ est√° offline', 'aviso');
        });

        // ========================================
        // ANALYTICS E FEEDBACK
        // ========================================
        
        function registrarEvento(categoria, acao, label) {
            // Integra√ß√£o com Google Analytics
            if (typeof gtag !== 'undefined') {
                gtag('event', acao, {
                    'event_category': categoria,
                    'event_label': label
                });
            }
            
            // Integra√ß√£o com Clarity
            if (typeof clarity !== 'undefined') {
                clarity('event', categoria, { action: acao, label: label });
            }
            
            console.log('Evento registrado:', categoria, acao, label);
        }

        // Registra eventos importantes
        function registrarUsoRecurso(recurso) {
            registrarEvento('Recurso', 'Uso', recurso);
        }

        // ========================================
        // EASTER EGGS E INTERA√á√ïES ESPECIAIS
        // ========================================
        
        let contadorCliquesLogo = 0;
        document.querySelector('.logo-area').addEventListener('click', () => {
            contadorCliquesLogo++;
            
            if (contadorCliquesLogo === 5) {
                mostrarToast('üéâ Voc√™ descobriu um segredo!', 'sucesso');
                adicionarMensagem(
                    'üéä **Parab√©ns!** Voc√™ encontrou um Easter Egg!\n\n' +
                    'Voc√™ √© curioso(a) e isso √© √≥timo! Continue explorando e aprendendo. üíô',
                    'cici',
                    false
                );
                contadorCliquesLogo = 0;
            }
        });

        // Mensagens especiais em datas comemorativas
        function verificarDatasEspeciais() {
            const hoje = new Date();
            const dia = hoje.getDate();
            const mes = hoje.getMonth() + 1;
            
            const datasEspeciais = {
                '25/12': 'üéÑ Feliz Natal! Que este dia seja repleto de amor e paz.',
                '01/01': 'üéä Feliz Ano Novo! Que este ano traga muitas realiza√ß√µes!',
                '01/10': 'üëµüë¥ Feliz Dia do Idoso! Voc√™ √© especial!',
                '03/12': '‚ôø Dia Internacional da Pessoa com Defici√™ncia - Inclus√£o √© essencial!'
            };
            
            const chaveData = `${dia.toString().padStart(2, '0')}/${mes.toString().padStart(2, '0')}`;
            
            if (datasEspeciais[chaveData]) {
                setTimeout(() => {
                    adicionarMensagem(datasEspeciais[chaveData], 'cici', false);
                }, 2000);
            }
        }

        // ========================================
        // INICIALIZA√á√ÉO FINAL
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            verificarDatasEspeciais();
            atualizarSugestoes();
            
            // Remove splash screen se existir
            setTimeout(() => {
                const splash = document.querySelector('.splash-screen');
                if (splash) splash.remove();
            }, 2000);
        });

        // Previne zoom em iOS
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // ========================================
        // ACESSIBILIDADE ADICIONAL
        // ========================================
        
        // An√∫ncio para leitores de tela
        function anunciarParaLeitor(texto) {
            const anuncio = document.createElement('div');
            anuncio.className = 'sr-only';
            anuncio.setAttribute('role', 'status');
            anuncio.setAttribute('aria-live', 'polite');
            anuncio.textContent = texto;
            document.body.appendChild(anuncio);
            
            setTimeout(() => anuncio.remove(), 1000);
        }

        // Foco vis√≠vel para navega√ß√£o por teclado
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-nav');
            }
        });

        document.addEventListener('mousedown', () => {
            document.body.classList.remove('keyboard-nav');
        });

        // ========================================
        // CONSOLE INFORMATIVO
        // ========================================
        
        console.log('%cü§ñ Cici - Assistente Virtual', 'font-size: 20px; font-weight: bold; color: #6c5ce7;');
        console.log('%cVers√£o: 2.0 Pro', 'font-size: 12px; color: #666;');
        console.log('%cDesenvolvido por AmplaAI com ‚ù§Ô∏è para acessibilidade e inclus√£o', 'font-size: 12px; color: #666;');
        console.log('%c‚ö†Ô∏è Aten√ß√£o: N√£o cole c√≥digos aqui se voc√™ n√£o sabe o que est√° fazendo!', 'font-size: 14px; color: #d63031; font-weight: bold;');
        
    </script>
</body>
</html>